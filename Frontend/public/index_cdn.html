<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detección de Anomalías Financieras</title>
    <!-- Bootstrap CSS desde CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Estilos personalizados -->
    <style>
        .container { max-width: 800px; margin-top: 30px; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .results-container { margin-top: 30px; }
        .chart-container { height: 300px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Detección de Anomalías en Datos Financieros</h1>
        
        <div class="card">
            <div class="card-header bg-primary text-white">
                Cargar Archivo
            </div>
            <div class="card-body">
                <form id="upload-form">
                    <div class="mb-3">
                        <label for="file" class="form-label">Selecciona un archivo CSV o Excel</label>
                        <input class="form-control" type="file" id="file" accept=".csv,.xlsx,.xls">
                        <div class="form-text">Formatos permitidos: CSV, Excel (.xlsx, .xls)</div>
                    </div>
                    <button type="submit" class="btn btn-primary">Cargar y Analizar</button>
                </form>
            </div>
        </div>
        
        <div id="loading" class="text-center d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p>Procesando datos...</p>
        </div>
        
        <div id="results" class="results-container d-none">
            <div class="card">
                <div class="card-header bg-success text-white">
                    Resultados del Análisis
                </div>
                <div class="card-body">
                    <h5 class="card-title">Resumen de Anomalías Detectadas</h5>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6>Isolation Forest</h6>
                                    <p id="isolation-forest-results">-</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6>Local Outlier Factor</h6>
                                    <p id="lof-results">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6>Anomalías Comunes</h6>
                        <p id="common-anomalies">-</p>
                    </div>
                    
                    <div class="mt-4">
                        <h6>Registros con Anomalías</h6>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="anomaly-records">
                                <thead>
                                    <tr id="anomaly-header"></tr>
                                </thead>
                                <tbody id="anomaly-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="error-message" class="alert alert-danger d-none" role="alert">
            Error al procesar el archivo.
        </div>
    </div>

    <!-- Scripts desde CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const uploadForm = document.getElementById('upload-form');
            const fileInput = document.getElementById('file');
            const loadingElement = document.getElementById('loading');
            const resultsElement = document.getElementById('results');
            const errorElement = document.getElementById('error-message');
            
            // API URL
            const API_URL = 'http://localhost:5000';
            
            uploadForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!fileInput.files.length) {
                    alert('Por favor selecciona un archivo');
                    return;
                }
                
                const file = fileInput.files[0];
                const formData = new FormData();
                formData.append('file', file);
                
                // Mostrar cargando
                loadingElement.classList.remove('d-none');
                resultsElement.classList.add('d-none');
                errorElement.classList.add('d-none');
                
                try {
                    // Paso 1: Cargar el archivo
                    const uploadResponse = await fetch(`${API_URL}/api/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!uploadResponse.ok) {
                        throw new Error('Error al cargar el archivo');
                    }
                    
                    const uploadData = await uploadResponse.json();
                    
                    // Paso 2: Analizar los datos
                    const analyzeResponse = await fetch(`${API_URL}/api/analyze`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            filepath: uploadData.filepath
                        })
                    });
                    
                    if (!analyzeResponse.ok) {
                        throw new Error('Error al analizar los datos');
                    }
                    
                    const results = await analyzeResponse.json();
                    
                    // Mostrar resultados
                    displayResults(results.results);
                    
                    // Ocultar cargando y mostrar resultados
                    loadingElement.classList.add('d-none');
                    resultsElement.classList.remove('d-none');
                    
                } catch (error) {
                    console.error('Error:', error);
                    loadingElement.classList.add('d-none');
                    errorElement.textContent = error.message || 'Error al procesar el archivo';
                    errorElement.classList.remove('d-none');
                }
            });
            
            function displayResults(results) {
                // Mostrar resultados de Isolation Forest
                const isolationForestElement = document.getElementById('isolation-forest-results');
                isolationForestElement.textContent = `Algoritmo: ${results.isolation_forest.algorithm}, Anomalías: ${results.isolation_forest.anomaly_count} de ${results.isolation_forest.total_records} registros`;
                
                // Mostrar resultados de Local Outlier Factor
                const lofElement = document.getElementById('lof-results');
                lofElement.textContent = `Algoritmo: ${results.local_outlier_factor.algorithm}, Anomalías: ${results.local_outlier_factor.anomaly_count} de ${results.local_outlier_factor.total_records} registros`;
                
                // Mostrar anomalías comunes
                const commonAnomaliesElement = document.getElementById('common-anomalies');
                commonAnomaliesElement.textContent = `${results.common_anomalies.count} anomalías detectadas por ambos algoritmos. Índices: ${results.common_anomalies.indices.join(', ')}`;
                
                // Mostrar registros con anomalías
                const anomalyRecords = results.anomaly_records;
                if (anomalyRecords && anomalyRecords.length) {
                    const headerRow = document.getElementById('anomaly-header');
                    const tableBody = document.getElementById('anomaly-body');
                    
                    // Limpiar tabla
                    headerRow.innerHTML = '';
                    tableBody.innerHTML = '';
                    
                    // Crear encabezados
                    const columns = Object.keys(anomalyRecords[0]);
                    columns.forEach(column => {
                        const th = document.createElement('th');
                        th.textContent = column;
                        headerRow.appendChild(th);
                    });
                    
                    // Crear filas
                    anomalyRecords.forEach(record => {
                        const tr = document.createElement('tr');
                        columns.forEach(column => {
                            const td = document.createElement('td');
                            td.textContent = record[column];
                            tr.appendChild(td);
                        });
                        tableBody.appendChild(tr);
                    });
                }
            }
        });
    </script>
</body>
</html>
